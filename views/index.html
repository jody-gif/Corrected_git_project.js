<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Ride Hailing</title>
    <style>
        #map {
            width: 100%;
            height: 100%;
        }

        html, body {
            width: 100%;
            height: 100%;
        }

        #overlay-panel {
            position: absolute;
            top: 65%;
            left: 20px;
            width: 200px;
            border: 5px double blue;
            z-index: 5;
            background-color: #BEE0F3;
        }

        h4 {
            margin-left: 10px;
        }

        input {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div id="overlay-panel">
        <!-- Form for setting the Route (Start Point and Destination) -->
        <form method="POST" action="/requestRoute">
            <!-- Start Point -->
            <h4>Start Point</h4>
            <input type="text" id="sourceAddress" placeholder="Enter your Start Point" name="source" required>
            <!-- Hidden Latitude and Longitude values calculated when the Source Address is filled in by the Google API service -->
            <input type="hidden" id="sourceLatitudeField" name="sourceLatitude" value=0>
            <input type="hidden" id="sourceLongitudeField" name="sourceLongitude" value=0>

            <!-- Destination -->
            <h4>Destination</h4>
            <input type="text" id="destinationAddress" placeholder="Enter your Destination" name="destination" required>
            <!-- Hidden Latitude and Longitude values calculated when the Destination Address is filled in by the Google API service -->
            <input type="hidden" id="destinationLatitudeField" name="destinationLatitude" value=0>
            <input type="hidden" id="destinationLongitudeField" name="destinationLongitude" value=0>

            <br><br>

            <!-- See Route Button -->
            <input id="routeBtn" type="submit" name="submit" value="See Routes">

            <br><br>

        </form>
    </div>
    <!-- the map div where the Google Map is displayed -->
    <div id="map"></div>
    <!-- The script enabling the Google Map as well as the libary enabling the locations, their addresses and their longitude/latitude values -->
    <!-- you need to replace "[YOUR_API_KEY]" with the key you got from the Google Maps API service -->
    <!-- calls the initMap function to load the map -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?libraries=places&key=[YOUR_API_KEY]&callback=initMap"></script>
    <script>
        // get list of vehicles from databases.js file
        let { vehicles } = require("./../js/vehicles");

        google.maps.event.addDomListener(window, "load", initialise);

        function initMap() {
            // enables routes to be calculated and displayed via the Google Maps API
            let dirService = new google.maps.DirectionsService();
            let dirDisplay = new google.maps.DirectionsRenderer();

            // centres the map on Whitechapel Station (start location)
            let whitechapelStation = { lat: 51.5195786, lng: -0.0606907 };
            let map = new google.maps.Map(
                document.getElementById("map"), { center: whitechapelStation, zoom: 8 }
            );

            // plot each vehicle on th map with a marker
            for (var i = 0; i < vehicles.length; i++) {
                let marker = new google.maps.Marker({ map: map, position: vehicles[i].position });
            }

            // allows routes to be shown on the map
            dirDisplay.setMap(map);

            // a event that calls the calculateAndRenderRoute function when triggered
            var onRouteSet = function () {
                calculateAndRenderRoute(dirService, dirDisplay);
            }

            // adds an event listener to the routeBtn so that when it is pressed ("submit"), it triggers the onRouteSet event
            document.getElementById("routeBtn").addEventListener("submit", onRouteSet);


            // calculates the route between the start and end points and shows the route on the map
            const calculateAndRenderRoute = (dirService, dirDisplay) => {
                let request = {
                    // gets the start point latitude/longitude from the form the client filled out
                    origin: {
                        lat: document.getElementById("sourceLatitudeField").value,
                        lng: document.getElementById("sourceLongitudeField").value
                    },
                    // gets the destination latitude/longitude from the form the client filled out
                    destination: {
                        lat: document.getElementById("destinationLatitudeField").value,
                        lng: document.getElementById("destinationLongitudeField").value
                    },
                    // specifies that the route is a driving route
                    travelmode: "DRIVING"
                }

                dirService.route(request, (result, status) => {
                    if (status === "OK") {
                        // if the route is possible, sets the directions of the route
                        dirDisplay.setDirections(result);
                    } else {
                        dirDisplay.setDirections(null);
                        window.alert(status);
                    }
                });
            }
        }

        function initialise() {
            // sets for the Google API to autocomplete the source/destination addresses typed the form by the client
            var autocompleteSource = new google.maps.places.Autocomplete(document.getElementById("sourceAddress"));
            var autocompleteDestination = new google.maps.places.Autocomplete(document.getElementById("destinationAddress"));

            // add event listener to autocomplete the source location input by the client
            google.maps.event.addListener(autocompleteSource, "place_changed", () => {
                // finds the place corresponding to the address
                var source = autocompleteSource.getPlace();
                // sets the latitude and longitude values associated with that source location
                document.getElementById("sourceLatitudeField").value = source.geometry.location.A;
                document.getElementById("sourceLongitudeField").value = source.geometry.location.F;
            });

            // add event listener to autocomplete the destination location input by the client
            google.maps.event.addListener(autocompleteDestination, "place_changed", () => {
                // finds the place corresponding to the address
                var destination = autocompleteDestination.getPlace();
                // sets the latitude and longitude values associated with that destination location
                document.getElementById("destinationLatitudeField").value = destination.geometry.location.A;
                document.getElementById("destinationLongitudeField").value = destination.geometry.location.F;
            });
        }

    </script>
</body>
</html>
